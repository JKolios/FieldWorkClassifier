# FieldWorkClassifier

A microservice-based system that generates farm work timetables based on
(emulated) JSON payloads from mobile devices. Uses ElasticSearch v5 for
 Indexing, Geo-queries and Aggregations. Written in Go 1.7.


## Structure


FieldWorkClassifier comprises two microservices: Indexer and QueryRunner.

Indexer's role is to receive JSON payloads from either HTTP or Websocket
API endpoints, preprocess and index them in a form allowing for efficient
searches.

QueryRunner runs Elasticsearch queries on the data that was stored by the
Indexer. The results of these queries are returned through its HTTP API.

The project also includes two helper utilities: PolygonImporter, which
imports GeoJSON-formatted field coordinates into the Indexer, and
RandomDataGenerator, which (as the name implies) generates random test
data.

## Usage with Docker

* Install Docker-compose, if needed.
* To start the service, run `docker-compose up --build`. It may take up
to 60 seconds for the ElasticSearch cluster to initialize. The
microservices will connect to the cluster as soon as it's available.
* Initialize the field geodata by running `go run PolygonImporter` under
`PolygonImporter`. You can use the provided polygons.json or substitute it
with any valid GeoJSON FeatureCollection file containing polygons.
This file was generated using [geojson.io](http://geojson.io/).
 Any FeatureCollection generated by that site should be able to be imported into the system.
* Running `go run RandomDataGenerator` under `RandomDataGenerator` will
populate the cluster with randomized data.

Alternatively, Indexer and QueryRunner instances can also be created as
independent Docker containers.

## HTTP/WS API

By default, on the docker-compose setup, the Indexer service runs on
`http://localhost:8090` and the QueryRunner service runs on
`http://localhost:8090`.

### Indexer

* POST /v0/deviceData

Receives the JSON data payloads from the mobile devices.

 Payload example:
 ```json
 {
    "company_id":100,
    "driver_id":10,
    "timestamp":"2017-05-27T22:24:40+00:00",
    "latitude":52.17730033847491,
    "longitude":11.442604064941404,
    "accuracy":12.0,
    "speed":80.1
 }
 ```

Response Example:
 ```json
{
  "_index": "device_data",
  "_type": "device_data",
  "_id": "777a57fb-315f-433b-8e98-242183aeac34",
  "_version": 1,
  "created": true
}
 ```

* GET  wsDeviceData

A Websocket version of `/v0/deviceData`. After upgrading to a Websocket connection,
this endpoint receives JSON payloads formatted exactly like `/v0/deviceData` and
emits replies formatted in the same manner.

* POST /v0/field

Receives the definitions of the fields. Used for geofencing drivers. Field
coordinates are uploaded as a GeoJSON Multipolygon.

 Payload example:
 ```json
 [
 	[
 		[
 			11.3433837890625,
 			52.15455702760558
 		],
 		[
 			11.32759094238281,
 			52.12505765485123
 		],
 		[
 			11.368789672851562,
 			52.11325243469631
 		],
 		[
 			11.39007568359375,
 			52.12294980913476
 		],
 		[
 			11.378402709960938,
 			52.14444515792554
 		],
 		[
 			11.3433837890625,
 			52.15455702760558
 		]
 	]
 ]
 ```

Response Example:
 ```json
{
  "_index": "fields",
  "_type": "field_locations",
  "_id": "field_locations",
  "_version": 3,
  "created": false,
  "get": null
}
 ```


* GET /v0/status

A simple status responder. Responds with the string `OK` to any request.


### QueryRunner

* POST /timeTableQuery

TimeTableQuery returns the daily timetable (listing of tasks with their durations)
for a particular driver of one particular company on a given day.

It expects a JSON POST body with three parameters:

    1. driverId (int): The driver's Id
    2. companyId (int): The Company's Id
    3. day (timestamp): A timestamp denoting the day. This can correspond to
 any moment within the day. This Timestamp syntax is used:
  `"2017-05-27T00:00:21+00:00"`

Example Payload:

```json
{
	"driverId": 999,
	"companyId": 999,
	"day": "2017-05-27T00:00:21+00:00"
}
```

Example Response:

```json
{
	"driverId": 999,
	"companyId": 999,
	"day": "27/05/2017",
	"activities": [{
		"from": "2017-05-27T22:19:00Z",
		"to": "2017-05-27T22:22:00Z",
		"activity": "Driving",
		"duration": "3m0s"
	}, {
		"from": "2017-05-27T22:24:20Z",
		"to": "2017-05-27T22:24:40Z",
		"activity": "Driving",
		"duration": "20s"
	}]
}
```


* GET /v0/status

A simple status responder. Responds with the string `OK` to any request.
